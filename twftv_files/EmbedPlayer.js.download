window.dataLayerObj={};let GATimer_Play_alive,GATimer_Video_view;let GAID=window.Param.GAID||"UA-51469004-12";let GAMode=window.location.pathname.split("/")[1];let GAMode1=window.location.pathname.split("/")[1];if(GAMode1=="page"){var GA_Ids=["G-PN6K82ZN4L"];}else{var GA_Ids=["UA-63498140-2",GAID,"UA-63498140-21","G-5HN73V0GHH"];}
document.write('<script async src="https://www.googletagmanager.com/gtag/js?id='+
GA_Ids[1]+
'"></script>');window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag("js",new Date());(function(){var _comscore=_comscore||[];_comscore.push({c1:"2",c2:"28889464"});(function(){var s=document.createElement("script"),el=document.getElementsByTagName("script")[0];s.async=true;s.src=(document.location.protocol=="https:"?"https://sb":"http://b")+
".scorecardresearch.com/beacon.js";el.parentNode.insertBefore(s,el);})();!(function(t,n){t[n]=t[n]||{nlsQ:function(e,o,c,r,s,i){return((s=t.document),(r=s.createElement("script")),(r.async=1),(r.src=("http:"===t.location.protocol?"http:":"https:")+
"//cdn-gl.imrworldwide.com/conf/"+
e+
".js#name="+
o+
"&ns="+
n),(i=s.getElementsByTagName("script")[0]),i.parentNode.insertBefore(r,i),(t[n][o]=t[n][o]||{g:c||{},ggPM:function(e,c,r,s,i){(t[n][o].q=t[n][o].q||[]).push([e,c,r,s,i]);},}),t[n][o]);},};})(window,"NOLBUNDLE");let apid=Param.ADProject=="FTVNews"?"PE2CD5370-6EE2-4B1F-AEA5-3065CCEA126B":"FTV"?"P66D07520-65C2-489C-9523-1C403224205E":"P7AA684AF-7AE0-4678-9961-56B6915E19AA";window.nSdkInstance=NOLBUNDLE.nlsQ(apid,"nlsnInstance",{optout:"false",});})();(function(){let Param={};Param.Player=null;Param.UAParser=null;Param.AD=null;Param.LastADTime=0;Param.ADCount=0;Param.MidrollEnd=0;Param.ADType=null;Param.Title=window.Param.Title||"4gTVPlayer";Param.Description=window.Param.Description||"";Param.GetURLAPI=window.Param.GetURLAPI||"https://app.4gtv.tv/Data/GetChannelURL_Mozai.ashx";Param.HiNetSite=Param.GetURLAPI.indexOf("/HiNet/")>0;Param.Type=window.Param.Type||"LIVE";Param.ChannelId=window.Param.ChannelId||"4gtv-4gtv002";Param.ContentId=window.Param.ContentId||Param.ChannelId;Param.GetUrlStruct=window.Param.GetUrlStruct||{Type:Param.Type,ChannelId:Param.ContentId,HostURL:document.referrer,};Param.PlayerContainer=window.Param.PlayerContainer||"#videoPlay";Param.GAID=window.Param.GAID||"UA-51469004-12";Param.UAParserPath=window.Param.UAParserPath||"../js/package/ua-parser.min.js";Param.GetADAPI=window.Param.GetADAPI||"https://service.4gtv.tv/4gtv/Data/GetAD.ashx";Param.ADLogAPI=window.Param.ADLogAPI||"https://service.4gtv.tv/4gtv/Data/ADLog.ashx";Param.ADProject=window.Param.ADProject||"4gtv";Param.ADPlatform=window.Param.ADPlatform||"Web";Param.ADContentType=window.Param.ADContentType||"Live";Param.ADDisplayType=window.Param.ADDisplayType||"all";Param.ADCooldownTime=typeof window.Param.ADCooldownTime==="number"?window.Param.ADCooldownTime:3*60;Param.RedirectURL=window.Param.RedirectURL||"https://www.4gtv.tv";Param.LoadingPic=window.Param.LoadingPic||"https://embed.4gtv.tv/img/4gTVPlayerMask/loadingbn_4GTV.jpg";Param.IsLive=Param.Type.toUpperCase()=="LIVE";Param.AutoPlay=typeof window.Param.AutoPlay==="boolean"?window.Param.AutoPlay:true;Param.Muted=typeof window.Param.Muted==="boolean"?window.Param.Muted:false;Param.FullScreen=typeof window.Param.FullScreen==="boolean"?window.Param.FullScreen:true;Param.PlayPause=typeof window.Param.PlayPause==="boolean"?window.Param.PlayPause:!Param.IsLive;Param.Progress=typeof window.Param.Progress==="boolean"?window.Param.Progress:!Param.IsLive;Param.TimeoutLimit=typeof window.Param.TimeoutLimit==="number"?window.Param.TimeoutLimit:4*60*60;Param.PlayAD=typeof window.Param.PlayAD==="boolean"?window.Param.PlayAD:true;Param.ADLog=typeof window.Param.ADLog==="boolean"?window.Param.ADLog:true;Param.Debug=typeof window.Param.Debug==="boolean"?window.Param.Debug:false;let assetList={"4gtv-4gtv002":"c44","litv-ftv13":"c46","4gtv-4gtv003":"c45","4gtv-4gtv001":"c47","litv-ftv09":"c94","4gtv-4gtv004":"c49","litv-ftv07":"c48",};let subbrand=assetList[Param.ContentId];Param.Nielsen={Log:Object.keys(assetList).includes(Param.ContentId),ContentObj:{type:"content",assetid:Param.ContentId,program:Param.Title+" livestream",title:Param.Title+" livestream",length:"86400",isfullepisode:"y",adloadtype:"2",subbrand:subbrand,},AdObj:(type)=>({type:type,assetid:"ad-"+Param.ContentId+Math.floor(Date.now()/1000),}),};let ConsoleLog=function ConsoleLog(...data){if(Param.Debug)console.log(...data);};let Import=function Import(url,callback){var head=document.getElementsByTagName("head")[0];var script=document.createElement("script");script.type="text/javascript";script.src=url;script.async=false;return new Promise(function(resolve,reject){script.error=reject;if(script.readyState){script.onreadystatechange=function(){if(script.readyState=="loaded"||script.readyState=="complete"){script.onreadystatechange=null;if(typeof callback==="function")callback();resolve();}};}else{script.onload=function(){if(typeof callback==="function")callback();resolve();};}
head.appendChild(script);});};let API={GetChannelURL:function GetChannelURL(){return new Promise(function(resolve,reject){$.ajax(Param.GetURLAPI,{data:Param.GetUrlStruct,dataType:"jsonp",jsonpCallback:"channelname",}).done(function(result){const VENDOR=result.fsVENDOR;dataLayerObj["event"]="page_view";dataLayerObj["title"]=Param.Title;dataLayerObj["ContentID"]=Param.ChannelId;dataLayerObj["ContentTitle"]=Param.Title;dataLayerObj["Category"]="channel";dataLayerObj["ContentVendor"]=VENDOR;dataLayerObj["Memo"]="adv=Y;Msg=00";AnalyticsLayer(dataLayerObj);resolve(result);}).fail(function(exception){ConsoleLog(exception);reject(exception);});});},GetAD:function GetAD(){return new Promise(function(resolve,reject){$.ajax(Param.GetADAPI,{data:{Project:Param.ADProject,Platform:Param.ADPlatform,ContentType:Param.ADContentType,DisplayType:Param.ADDisplayType,Content:Param.ContentId,},dataType:"json",}).done(function(result){resolve(result);}).fail(function(exception){ConsoleLog(exception);reject(exception);});});},GetHiNetVast:function GetHiNetVast(){return new Promise(function(resolve,reject){const URL=["https://static.cht.hinet.net/api/v1/request/vast?key=9DL7GON1GD21QJ4K",];resolve(URL);});},};let AD={GetData:function GetData(){if(Param.PlayAD){let GetAdArray=[API.GetAD()];if(Param.HiNetSite)GetAdArray.push(API.GetHiNetVast());return Promise.all(GetAdArray).then(function(data){Param.AD=data[0];if(Param.HiNetSite){let vast=AD.WrapVAST(data[1],"video","vast","HiNet");Param.AD.preroll=vast.concat(Param.AD.preroll);Param.AD.midroll=vast.concat(Param.AD.midroll);}
if(Param.ADLog)
return import(Param.UAParserPath).then(function(){Param.UAParser=Param.UAParser||UAParser();ConsoleLog("UserAgent",Param.UAParser);}).catch(function(){ConsoleLog("UAParser Undefined");});}).catch(function(err){ConsoleLog(err.message);Param.PlayAD=false;});}else return Promise.resolve;},PostBack:function PostBack(pstrURL){if(document.images){if(pstrURL!=""){let img=new Image();img.src=pstrURL;}}},ADLog:function ADLog(event,adType,data){if(Param.ADLog){let logData={Display_Type:adType,Event:event,Seq:data.seq,Project:data.project,AD_Vendor:data.vendor,AD_ID:data.tag_id,Asset_ID:data.content,};let parser=Param.UAParser;if(parser){if(parser.os){logData.OS=parser.os.name;logData.OS_Version=parser.os.version;}
if(parser.browser){logData.Browser=parser.browser.name;logData.Browser_Version=parser.browser.version;}
if(parser.device&&parser.device.vendor){logData.Device_Vendor=parser.device.vendor;logData.Device_Type=parser.device.model;}}else logData.Browser="UaParserUndefined";AD.PostBack(Param.ADLogAPI+"?"+$.param(logData));if(typeof dataLayerObj==="object"&&typeof AnalyticsLayer==="function"){dataLayerObj["Type"]=adType;dataLayerObj["event"]=event=="request"?"adv_request":event=="start"?"adv_impression":"";dataLayerObj["Seq"]=data.seq;dataLayerObj["Memo"]=data.project;dataLayerObj["Tag"]=data.tag_id;dataLayerObj["AdVendor"]=data.vendor;AnalyticsLayer(dataLayerObj);}}},WrapVAST:function WrapVAST(vasts,media_type,schema,space_header){var wrapArr=[];for(var i=0;i<vasts.length;i++){var vasturl=vasts[i];var domain=vasturl.split("/")[2];domain=domain.split(".").join("-");if(vasturl.indexOf("https")==-1)
vasturl="https"+vasturl.substring(vasturl.indexOf(":"),vasturl.length);wrapArr.push({media_type:media_type,schema:schema,project:Param.ADProject+
"-"+
Param.ADPlatform+
"-"+
Param.ADContentType,vendor:"HiNet_COMPANY",tag_id:domain,data:{tag:vasturl,},remark:"",});}
return wrapArr;},};let Url={GetParam:function GetParam(){let strSearch=location.search;let Param={};if(strSearch.indexOf("?")!=-1){let lstUrlParam=strSearch.substring(strSearch.indexOf("?")+1).split("&").filter(function(elem){if(elem)return elem;});lstUrlParam.forEach(function(obj){if(obj){let data=obj.split("=");Param[data[0].toLowerCase()]=data[1];}});}
return Param;},};String.prototype.SetUrlParams=function SetUrlParams(){let tag=this;let playerwidth=$(Param.PlayerContainer).css("width").replace(/px/g,"");let playerheight=$(Param.PlayerContainer).css("height").replace(/px/g,"");tag=tag.replace(/\[timestamp\]/g,Date.now());tag=tag.replace(/\[playerwidth\]/g,Math.round(playerwidth));tag=tag.replace(/\[playerheight\]/g,Math.round(playerheight));tag=tag.replace(/\[pageURL\]/g,encodeURIComponent(document.URL));tag=tag.replace(/\[urlencodedpageURL\]/g,encodeURIComponent(document.URL));tag=tag.replace(/\[referrer_url\]/g,encodeURIComponent(document.URL));tag=tag.replace(/\[description_url\]/g,encodeURIComponent(document.URL));tag=tag.replace(/\[referrer_url\]/g,encodeURIComponent(document.URL));tag=tag.replace(/\[is-lat\]/g,0);tag=tag.replace(/\[vtype\]/g,'live');tag=tag.replace(/\[uid2\]/g,'');return tag;};let CryptoJsArray=[Import("/js/EncryptDecrypt/core.js"),Import("/js/EncryptDecrypt/enc-base64.js"),Import("/js/EncryptDecrypt/cipher-core.js"),Import("/js/EncryptDecrypt/niubi.js"),];(function(){if(Param.HiNetSite)return Promise.all(CryptoJsArray);return Promise.resolve();})().then(API.GetChannelURL).then(function(data){if(Param.HiNetSite)data.VideoURL=Secrect.decrypt(data.VideoURL);Param.playSources=data.VideoURLs||[data.VideoURL];if(data.RedirectURL&&!window.Param.RedirectURL)
Param.RedirectURL=data.RedirectURL;}).then(AD.GetData).then(function(){Param.UrlParam=Url.GetParam();if(Param.UrlParam.player_autoplay)
Param.AutoPlay=Param.UrlParam.player_autoplay=="off"?false:true;if(Param.UrlParam.player_fullscreen)
Param.FullScreen=Param.UrlParam.player_fullscreen=="off"?false:true;if(Param.UrlParam.player_mute)
Param.Muted=Param.UrlParam.player_mute!="on"?false:true;let PlayerInitial=function PlayerInitial(){if(GATimer_Play_alive)clearInterval(GATimer_Play_alive);let player=new ftvplayer(Param.PlayerContainer,{autoplay:Param.AutoPlay,playAD:Param.PlayAD,isLive:Param.IsLive,muted:Param.Muted,scope:"embed",leadvideo:false,switch:{showpaybits:false,},ui:{fullscreen:Param.FullScreen,playpause:Param.PlayPause,progress:Param.Progress,setting:false,logo:false,},embed:{PlayLengthLimit:{sre:0,end:0,},},playlist:[{playad:true,poster:Param.LoadingPic,sources:Param.playSources,content:Param.ContentId,},],timeout:{second:Param.TimeoutLimit,onshow:function(){ConsoleLog("播放時間逾時",Param.TimeoutLimit);},onclick:function(){location.reload();},},});player.on("play",function(){console.log("播放中");});player.on("playstart",()=>{clearInterval(GATimer_Video_view);if(!player.paused()){console.log("playstart監聽到正片開始事件");GATimer_Video_view=setInterval(function(){dataLayerObj.event="video_view";dataLayerObj.ContentID=Param.ChannelId;dataLayerObj.Category="channel";AnalyticsLayer(dataLayerObj);},3000);}});let t1=Math.floor(Date.now()/1000);player.on("timeupdate",function(e){if(!player.paused()){const t2=Math.floor(Date.now()/1000);if(t2-t1>60){console.log("60秒了觸發play_alive");dataLayerObj.event="play_alive";dataLayerObj.ContentID=Param.ChannelId;AnalyticsLayer(dataLayerObj);t1=t2;}}});if(Param.Nielsen.Log){nSdkInstance.ggPM("loadMetadata",Param.Nielsen.ContentObj);player.on("play",function(data){nSdkInstance.ggPM("loadMetadata",Param.Nielsen.ContentObj);});player.on("contenttimechange",function(data){nSdkInstance.ggPM("setPlayheadPosition",Math.floor(Date.now()/1000));});$(window).bind("beforeunload",function(){nSdkInstance.ggPM("stop",Math.floor(Date.now()/1000));});}
if(Param.PlayAD){ConsoleLog("[播放廣告]");ConsoleLog("取得的廣告資料",Param.AD);Param.AD=JSON.parse(JSON.stringify(Param.AD).SetUrlParams());Param.ADCount=0;ConsoleLog("處理完的廣告資料",Param.AD);const ima=player.ima({tipText:false,posterTip:false,breaksecond:Param.ADCooldownTime,breakTag:["midroll"],});player.on("cansetad",function(data){ConsoleLog("設置廣告資料",Param.AD,data);let preroll=JSON.parse(JSON.stringify(Param.AD.preroll));preroll.forEach((obj)=>(obj.content=data.content));let p=ima.setAds("preroll",preroll);});if(Param.Nielsen.Log){player.on("adexposurestart",function(data){nSdkInstance.ggPM("loadMetadata",Param.Nielsen.AdObj(data.keyname));});player.on("adexposureprogress",function(data){nSdkInstance.ggPM("setPlayheadPosition",data.currentSecond);});player.on("adexposureend",function(data){nSdkInstance.ggPM("stop",data.currentSecond);});}
player.on("canplayad",function(data){CheckAdElapsed(function(){Param.ADType="preroll";ConsoleLog("可以播放廣告",data);ima.requestAdByType("preroll");});});player.on("adtagrequest",function(data){ConsoleLog("請求廣告",data);if(data.seq==1){ConsoleLog(data.keyname+" AD 0 req");AD.ADLog("request",data.keyname,{project:data.data.project,seq:0,content:data.data.content,vendor:"",tag_id:"",});}
ConsoleLog(data.keyname+" AD "+data.seq+" req",data);AD.ADLog("request",data.keyname,{...data.data,seq:data.seq});});player.on("adsuccess",function(data){ConsoleLog("廣告成功播放",data);ConsoleLog(data.keyname+" AD "+data.seq+" str",data);Param.ADCount+=1;AD.ADLog("start",data.keyname,{...data.data,seq:data.seq});});player.on("aderror",function(data){ConsoleLog("廣告發生錯誤",data);ConsoleLog(data.keyname+" AD "+data.seq+" err",data);});player.on("adcomplete",function(data){Param.LastADTime=Date.now();ConsoleLog("廣告播放完成",Param.LastADTime,data);ConsoleLog(data.keyname+" AD "+data.seq+" comp",data);let midrollRemainingTime=Param.MidrollEnd-Date.now();if(data.keyname=="midroll"&&midrollRemainingTime>0){ConsoleLog("廣告midroll時間未填滿，尚餘",midrollRemainingTime/1000);Param.ADType="midroll";ConsoleLog("進入midroll("+(Param.ADCount+1)+")",data);}else{Param.ADCount=0;}});player.on("playlistchange",function(res){const data=res.currentItem;if(Array.isArray(data.cuepoints)&&data.cuepoints.length>0){ConsoleLog("設置廣告破口",data.cuepoints);let cuepoint=player.cuepoint();cuepoint.destroy();const cues=data.cuepoints.map((cue)=>{return{namespace:"vod",start:cue,end:cue+16,params:{},onStart:function(params){Param.ADType="midroll";ConsoleLog("進入cuepoint",cue);ima.requestAdByType("midroll",true);},onEnd:function(params){ConsoleLog("離開cuepoint",cue);},};});cuepoint.add(cues);}});}else{ConsoleLog("[不播放廣告]");}};PlayerInitial();});let CheckAdElapsed=function CheckAdElapsed(callback){let adElapsedTime=(Date.now()-Param.LastADTime)/1000;if(Param.ADCount==0){if(adElapsedTime>Param.ADCooldownTime){callback();}else{ConsoleLog("距離前次廣告結束不足"+Param.ADCooldownTime+"s",adElapsedTime);}}else{ConsoleLog("廣告計數未歸零",Param.ADCount);}};})();if(GAMode1=="page"){GAMode="yahoo";GAMode1="yahoo";}else if(GAMode=="ftvnews"){GAMode="iframe";GAMode1="ftvnews";}
const referrer=document.referrer.split("/");referrer.pop();const ref_origin=referrer.join("/");const ExternalURL=document.referrer.indexOf(GAMode.toLowerCase());const postMessagewer=new Promise((resolve,reject)=>{if(ExternalURL===-1){const receiveMessage4gtv=window.addEventListener("message",(e)=>{window.removeEventListener("message",receiveMessage4gtv);if(ref_origin){if(e.origin===ref_origin){resolve(e.data);}}else{resolve(window.location.href);}});}else{resolve(ref_origin);}});window.AnalyticsLayer=function AnalyticsLayer(val){if(val){let dataObj={};Object.keys(val).forEach(function(t){dataObj[t]=val[t];});console.log(dataObj.event);let dimensions={page_title:dataObj["ContentTitle"],page_location:location.href,send_page_view:false,cookie_flags:"secure;samesite=none",custom_map:{dimension1:"ContentID",dimension2:"ContentTitle",dimension3:"Mode",dimension5:"Category",dimension6:"Type",dimension7:"Tag",dimension8:"ContentVendor",dimension10:"Memo",dimension11:"ClientID",dimension12:"AccountID",dimension13:"Seq",dimension14:"AdVendor",dimension15:"device_mode",dimension16:"ref_url",},};for(let i=0;i<GA_Ids.length;i++){let gtagId=GA_Ids[i];gtag("config",gtagId,dimensions);}
if(dataObj.event==="play_alive"){gtag("event",dataObj.event,{ContentID:dataObj["ContentID"],});}
else if(dataObj.event==="page_view"||dataObj.event==="video_view"){postMessagewer.then((embedURL)=>{console.log("==== 取得ref_url ===="+embedURL);gtag("event",dataObj.event,{ContentID:dataObj["ContentID"],Mode:GAMode1,Category:dataObj["Category"],ref_url:embedURL,});}).catch(function(err){console.error(err)});if(GATimer_Video_view)clearInterval(GATimer_Video_view);}
else{gtag("event",dataObj.event,{ContentID:dataObj["ContentID"],ContentTitle:dataObj["ContentTitle"],Mode:GAMode1,Category:dataObj["Category"],Type:dataObj["Type"],Tag:dataObj["Tag"],ContentVendor:dataObj["ContentVendor"],Memo:dataObj["Memo"],Seq:dataObj["Seq"],AdVendor:dataObj["AdVendor"],});}}};console.log("user_properties");gtag("set","user_properties",{device_mode:GAMode1,content_location:"channel",});const gclidPromise=new Promise((resolve)=>{for(let i=0;i<GA_Ids.length;i++){gtag("get",GA_Ids[i],"client_id",resolve);}});gclidPromise.then((clientId)=>{console.log("補送set");gtag("set","user_properties",{ClientID:clientId,});});